<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="spot_title">Fishing spot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app fade-in">
    <!-- Header -->
    <header class="card">
      <div class="card-header">
        <div>
          <h1 data-i18n="spot_title">Fishing spot</h1>
          <p class="muted-text" data-i18n="spot_subtitle">
            See details and catches for this spot.
          </p>
        </div>
        <button
          id="backBtn"
          class="secondary-btn"
          data-i18n="btn_back_main"
        >
          ← Back to main
        </button>
      </div>
    </header>

    <!-- Spot info + actions -->
    <section class="card">
      <div class="card-header">
        <div>
          <h2 id="spotName">…</h2>
          <div class="muted-text">
            <span data-i18n="spot_location_label">Location</span>:
            <span id="spotLocation"></span>
          </div>
        </div>
        <div class="spot-actions">
          <button
            id="addCatchBtn"
            class="secondary-btn"
            data-i18n="btn_add_catch"
          >
            Add catch
          </button>
          <button
            id="predictionsBtn"
            class="secondary-btn"
            data-i18n="btn_predictions"
          >
            Predictions
          </button>
          <button
            id="editSpotBtn"
            class="secondary-btn"
            data-i18n="btn_edit_spot"
          >
            Edit
          </button>
          <button
            id="deleteSpotBtn"
            class="danger-btn"
            data-i18n="btn_delete_spot"
          >
            Delete spot
          </button>
        </div>
      </div>
    </section>

    <!-- Catches list -->
    <section class="card">
      <h2 data-i18n="spot_catches_title">Catches at this spot</h2>
      <div id="catchesContainer"></div>
    </section>
  </div>

  <!-- i18n + app scripts -->
  <script src="i18n.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const t = window.t || ((k) => k);

    const params = new URLSearchParams(window.location.search);
    const spotId = params.get("id");

    const backBtn = document.getElementById("backBtn");
    const spotNameEl = document.getElementById("spotName");
    const spotLocationEl = document.getElementById("spotLocation");
    const catchesContainer = document.getElementById("catchesContainer");
    const addCatchBtn = document.getElementById("addCatchBtn");
    const predictionsBtn = document.getElementById("predictionsBtn");
    const editSpotBtn = document.getElementById("editSpotBtn");
    const deleteSpotBtn = document.getElementById("deleteSpotBtn");

    backBtn.onclick = () => {
      window.location.href = "index.html";
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      if (!spotId) {
        spotNameEl.textContent = t("spot_not_found") || "Spot not found";
        return;
      }

      try {
        const spotRef = doc(db, "spots", spotId);
        const spotSnap = await getDoc(spotRef);

        if (!spotSnap.exists()) {
          spotNameEl.textContent = t("spot_not_found") || "Spot not found";
          return;
        }

        const spot = { id: spotSnap.id, ...spotSnap.data() };

        spotNameEl.textContent = spot.name || (t("spot_no_name") || "Unnamed spot");

        if (
          typeof spot.latitude === "number" &&
          typeof spot.longitude === "number"
        ) {
          spotLocationEl.textContent =
            spot.latitude.toFixed(6) + ", " + spot.longitude.toFixed(6);
        } else {
          spotLocationEl.textContent = t("spot_location_unknown") || "Unknown";
        }

        // Button actions
        addCatchBtn.onclick = () => {
          window.location.href =
            "add-catch.html?spotId=" +
            encodeURIComponent(spot.id) +
            "&from=spot";
        };

        predictionsBtn.onclick = () => {
          window.location.href =
            "predictions.html?spotId=" + encodeURIComponent(spot.id);
        };

        editSpotBtn.onclick = () => {
          window.location.href =
            "edit-spot.html?id=" + encodeURIComponent(spot.id);
        };

        deleteSpotBtn.onclick = async () => {
          if (!confirm(t("confirm_delete_spot") || "Delete this spot?")) {
            return;
          }
          try {
            // delete spot document
            await deleteDoc(spotRef);

            // (optional) delete catches under this spot
            const qCatches = query(
              collection(db, "catches"),
              where("spotId", "==", spot.id),
              where("userId", "==", user.uid)
            );
            const cSnap = await getDocs(qCatches);
            const batchDeletes = cSnap.docs.map((d) =>
              deleteDoc(doc(db, "catches", d.id))
            );
            await Promise.all(batchDeletes);

            window.location.href = "index.html";
          } catch (err) {
            console.error(err);
            alert(t("error_delete_spot") || "Error deleting spot.");
          }
        };

        await loadCatches(user, spot.id);
      } catch (err) {
        console.error(err);
        spotNameEl.textContent = t("spot_load_error") || "Error loading spot.";
      }
    });

    async function loadCatches(user, spotId) {
      catchesContainer.innerHTML = "";

      const qCatches = query(
        collection(db, "catches"),
        where("userId", "==", user.uid),
        where("spotId", "==", spotId)
      );
      const snap = await getDocs(qCatches);

      if (snap.empty) {
        catchesContainer.innerHTML =
          '<p class="muted-text">' +
          (t("spot_no_catches") || "No catches yet.") +
          "</p>";
        return;
      }

      const catches = snap.docs
        .map((d) => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

      for (const c of catches) {
        const div = document.createElement("div");
        div.className = "catch-row";

        const species = c.species || (t("species_unknown") || "fish");
        const weight = typeof c.weightKg === "number" ? c.weightKg.toFixed(2) : "-";

        const date = c.timestamp
          ? new Date(c.timestamp).toLocaleDateString()
          : "";

        const lureText = c.lure || "-";
        const depthText =
          typeof c.depth === "number" ? c.depth.toFixed(1) + " m" : "-";
        const waterTempText =
          typeof c.temperature === "number"
            ? c.temperature.toFixed(1) + " °C"
            : "-";

        const weatherDesc =
          c.weatherDescription ||
          (t("catch_weather_unknown") || "No weather data");

        div.innerHTML = `
          <div class="catch-header">
            <strong>${escapeHtml(species)}</strong> • ${escapeHtml(
          weight
        )} kg ${escapeHtml(date)}
          </div>
          <div>${t("catch_lure_label") || "Lure"}: ${escapeHtml(
          lureText
        )}</div>
          <div>${t("catch_depth_label") || "Depth"}: ${escapeHtml(
          depthText
        )}</div>
          <div>${t("catch_watertemp_label") || "Water temp"}: ${escapeHtml(
          waterTempText
        )}</div>
          <div>${
            t("catch_weather_label") || "Weather at time of catch"
          }: ${escapeHtml(weatherDesc)}</div>
        `;

        const btnRow = document.createElement("div");
        btnRow.style.marginTop = "8px";

        const delBtn = document.createElement("button");
        delBtn.className = "danger-btn";
        delBtn.textContent =
          t("btn_delete_catch") || "Delete catch";
        delBtn.onclick = async () => {
          if (!confirm(t("confirm_delete_catch") || "Delete this catch?")) {
            return;
          }
          try {
            await deleteDoc(doc(db, "catches", c.id));
            await loadCatches(user, spotId);
          } catch (err) {
            console.error(err);
            alert(t("error_delete_catch") || "Error deleting catch.");
          }
        };

        btnRow.appendChild(delBtn);
        div.appendChild(btnRow);

        catchesContainer.appendChild(div);
      }
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>

  <script src="cookie-consent.js"></script>
</body>
</html>
