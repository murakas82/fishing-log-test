<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fishing spot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app fade-in">
    <header class="card">
      <div class="card-header">
        <div>
          <h1 data-i18n="spotPage.title">Fishing spot</h1>
          <p class="muted-text" data-i18n="spotPage.subtitle">See details and catches for this spot.</p>
        </div>
        <div>
          <button class="secondary-btn btn-back-main" id="backBtn" data-i18n="common.backToMain">
            ← Back to main
          </button>
        </div>
      </div>
    </header>

    <div class="card" id="spotCard">
      <div class="card-header">
        <div>
          <h2 id="spotName" data-i18n="common.loadingSpot">Loading spot…</h2>
          <p class="muted-text" id="spotLocation"></p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="secondary-btn" id="addCatchBtn" data-i18n="spotPage.addCatch">Add catch</button>
          <button class="secondary-btn" id="predictionsBtn" data-i18n="spotPage.predictions">Predictions</button>
          <button class="secondary-btn" id="editSpotBtn" data-i18n="spotPage.edit">Edit</button>
          <button class="danger-btn" id="deleteSpotBtn" data-i18n="spotPage.delete">Delete spot</button>
        </div>
      </div>
    </div>

    <div class="card" id="catchesCard">
      <h2 data-i18n="spotPage.catchesTitle">Catches at this spot</h2>
      <div id="catchesList" class="spot-catches-list"></div>
    </div>

    <div class="card" id="loadingCard" style="display:none;">
      <div class="loading-center">
        <div class="spinner"></div>
        <div data-i18n="common.loading">Loading…</div>
      </div>
    </div>
  </div>

  <!-- i18n -->
  <script src="translations.js"></script>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // i18n helpers
    const i18n = window.fishingLogI18n;
    const t = (key) => (i18n && typeof i18n.t === "function") ? i18n.t(key) : key;
    function reapplyTranslations() {
      if (i18n && typeof i18n.applyTranslations === "function") i18n.applyTranslations();
    }

    const backBtn        = document.getElementById("backBtn");
    const addCatchBtn    = document.getElementById("addCatchBtn");
    const predictionsBtn = document.getElementById("predictionsBtn");
    const editSpotBtn    = document.getElementById("editSpotBtn");
    const deleteSpotBtn  = document.getElementById("deleteSpotBtn");

    const spotNameEl     = document.getElementById("spotName");
    const spotLocationEl = document.getElementById("spotLocation");
    const catchesListEl  = document.getElementById("catchesList");
    const loadingCard    = document.getElementById("loadingCard");
    const catchesCard    = document.getElementById("catchesCard");

    const params = new URLSearchParams(window.location.search);
    const spotId = params.get("id") || params.get("spotId");

    backBtn.onclick = () => {
      window.location.href = "index.html";
    };

    if (addCatchBtn) {
      addCatchBtn.onclick = () => {
        if (!spotId) return;
        window.location.href =
          `add-catch.html?spotId=${encodeURIComponent(spotId)}&from=spot`;
      };
    }

    if (predictionsBtn) {
      predictionsBtn.onclick = () => {
        if (!spotId) return;
        window.location.href =
          `predictions.html?spotId=${encodeURIComponent(spotId)}`;
      };
    }

    if (editSpotBtn) {
      editSpotBtn.onclick = () => {
        if (!spotId) return;
        window.location.href =
          `edit-spot.html?spotId=${encodeURIComponent(spotId)}`;
      };
    }

    function renderMessage(key, fallbackHtml) {
      catchesListEl.innerHTML = fallbackHtml || "";
      reapplyTranslations();
    }

    async function loadSpot(user) {
      if (!spotId) {
        spotNameEl.textContent = t("spotPage.noSpotSelected");
        renderMessage(
          "spotPage.missingSpotId",
          `<p class="muted-text" data-i18n="spotPage.missingSpotId">Missing spot id in URL.</p>`
        );
        return;
      }

      loadingCard.style.display = "block";
      catchesCard.style.display = "none";

      const spotRef = doc(db, "spots", spotId);
      const snap = await getDoc(spotRef);

      if (!snap.exists()) {
        spotNameEl.textContent = t("spotPage.spotNotFound");
        spotLocationEl.textContent = "";
        renderMessage(
          "spotPage.spotDoesNotExist",
          `<p class="muted-text" data-i18n="spotPage.spotDoesNotExist">This spot does not exist.</p>`
        );
        loadingCard.style.display = "none";
        return;
      }

      const spot = snap.data();
      if (spot.userId !== user.uid) {
        spotNameEl.textContent = t("spotPage.accessDenied");
        renderMessage(
          "spotPage.belongsToAnotherUser",
          `<p class="muted-text" data-i18n="spotPage.belongsToAnotherUser">This spot belongs to another user.</p>`
        );
        loadingCard.style.display = "none";
        return;
      }

      spotNameEl.removeAttribute("data-i18n"); // avoid overwriting the actual name
      spotNameEl.textContent = spot.name || t("spotPage.unnamedSpot");

      if (typeof spot.latitude === "number" && typeof spot.longitude === "number") {
        spotLocationEl.textContent =
          `${t("spotPage.locationLabel")} ${spot.latitude.toFixed(4)}, ${spot.longitude.toFixed(4)}`;
      } else {
        spotLocationEl.textContent =
          `${t("spotPage.locationLabel")} ${t("spotPage.locationNotSet")}`;
      }

      const q = query(
        collection(db, "catches"),
        where("userId", "==", user.uid),
        where("spotId", "==", spotId)
      );
      const catchesSnap = await getDocs(q);

      if (catchesSnap.empty) {
        catchesListEl.innerHTML =
          `<p class="muted-text" data-i18n="spotPage.noCatchesYet">No catches at this spot yet.</p>`;
        reapplyTranslations();
      } else {
        const items = [];
        catchesSnap.forEach(docSnap =>
          items.push({ id: docSnap.id, ...docSnap.data() })
        );
        items.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

        catchesListEl.innerHTML = "";
        for (const c of items) {
          const row = document.createElement("div");
          row.className = "catch-row";

          const date = c.timestamp ? new Date(c.timestamp) : null;
          const dateText = date
            ? `${String(date.getDate()).padStart(2,"0")}.${String(date.getMonth()+1).padStart(2,"0")}.${date.getFullYear()}`
            : "-";

          const species = c.species || "-";
          const weight  = (typeof c.weightKg === "number" && !isNaN(c.weightKg))
            ? `${c.weightKg.toFixed(2)} kg`
            : "-";
          const lure    = c.lure || "-";
          const depth   = (typeof c.depth === "number" && !isNaN(c.depth))
            ? `${c.depth.toFixed(1)} m`
            : "-";
          const waterTemp = (typeof c.temperature === "number" && !isNaN(c.temperature))
            ? `${c.temperature.toFixed(1)} °C`
            : "-";
          const weatherDesc = c.weatherDescription || t("spotPage.noWeatherData");

          row.innerHTML = `
            <p><strong>${species}</strong> • ${weight} ${dateText}</p>
            <p><span data-i18n="spotPage.lureLabel">Lure</span>: ${lure}</p>
            <p><span data-i18n="spotPage.depthLabel">Depth</span>: ${depth}</p>
            <p><span data-i18n="spotPage.waterTempLabel">Water temp</span>: ${waterTemp}</p>
            <p><span data-i18n="spotPage.weatherAtCatchLabel">Weather at time of catch</span>: ${weatherDesc}</p>
            <button class="danger-btn catch-delete-btn" data-id="${c.id}" data-i18n="spotPage.deleteCatch">
              Delete catch
            </button>
          `;
          catchesListEl.appendChild(row);
        }

        reapplyTranslations();

        document.querySelectorAll(".catch-delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;

            const ok = confirm(t("spotPage.confirmDeleteCatch"));
            if (!ok) return;

            try {
              await deleteDoc(doc(db, "catches", id));
              btn.closest(".catch-row")?.remove();
              if (!catchesListEl.children.length) {
                catchesListEl.innerHTML =
                  `<p class="muted-text" data-i18n="spotPage.noCatchesYet">No catches at this spot yet.</p>`;
                reapplyTranslations();
              }
            } catch (err) {
              alert(`${t("spotPage.errorDeletingCatch")} ${(err.message || err)}`);
            }
          });
        });
      }

      loadingCard.style.display = "none";
      catchesCard.style.display = "block";
      reapplyTranslations();
    }

    async function handleDeleteSpot(user) {
      if (!spotId) return;

      const ok = confirm(t("spotPage.confirmDeleteSpot"));
      if (!ok) return;

      deleteSpotBtn.disabled = true;
      deleteSpotBtn.textContent = t("spotPage.deleting");

      try {
        const q = query(
          collection(db, "catches"),
          where("userId", "==", user.uid),
          where("spotId", "==", spotId)
        );
        const snap = await getDocs(q);
        const deletions = snap.docs.map(d => deleteDoc(doc(db, "catches", d.id)));
        await Promise.all(deletions);

        await deleteDoc(doc(db, "spots", spotId));

        alert(t("spotPage.spotDeleted"));
        window.location.href = "index.html";
      } catch (err) {
        alert(`${t("spotPage.errorDeletingSpot")} ${(err.message || err)}`);
        deleteSpotBtn.disabled = false;
        deleteSpotBtn.textContent = t("spotPage.deleteButtonFallback");
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      await loadSpot(user);
      deleteSpotBtn.onclick = () => handleDeleteSpot(user);
    });

    // Initial apply for static page strings
    reapplyTranslations();
  </script>
</body>
</html>
