<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>My fishing spots ‚Äì map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    #map {
      width: 100%;
      height: 420px;
      border-radius: 16px;
    }
    .legend {
      margin-top: 10px;
      font-size: 0.92rem;
      color: #9ca3af;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="app fade-in">
    <header class="card">
      <div class="card-header">
        <div>
          <h1 data-i18n="spotsMap.title">My fishing spots ‚Äì map</h1>
          <p class="muted-text" data-i18n="spotsMap.subtitle">
            See all your spots on an interactive map with live weather & predictions.
          </p>
        </div>
        <a class="secondary-btn btn-back-main" href="index.html" data-i18n="common.backToMain">‚Üê Back to main</a>
      </div>
    </header>

    <div class="card">
      <h2 data-i18n="spotsMap.overview">Spots overview</h2>
      <div id="map"></div>

      <div class="legend">
        <div data-i18n="spotsMap.legendDescription">
          ‚Ä¢ Marker color (tomorrow): ‚óè good (‚â•70%), ‚óè medium (40‚Äì69%), ‚óè poor (<40%).<br />
          ‚Ä¢ Popup shows live weather now and predictions for the next 3 days.
        </div>
      </div>
    </div>
  </div>

  <script src="translations.js"></script>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    import { computeDayScoreFromForecast } from "./predictions-core.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const i18n = window.fishingLogI18n;
    const t = (k) => (i18n && typeof i18n.t === "function") ? i18n.t(k) : k;

    let map;

    function dateLabelForOffset(offset) {
      const d = new Date();
      d.setDate(d.getDate() + offset);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function getWeatherIconAndLabel(code) {
      if (code === 0)  return { icon: "‚òÄÔ∏è", label: t("home.weatherClear") };
      if (code === 1)  return { icon: "üå§Ô∏è", label: t("home.weatherMainlyClear") };
      if (code === 2)  return { icon: "‚õÖ",  label: t("home.weatherPartlyCloudy") };
      if (code === 3)  return { icon: "‚òÅÔ∏è",  label: t("home.weatherOvercast") };

      if (code === 45 || code === 48) return { icon: "üå´Ô∏è", label: t("pred.weatherFog") };

      if ([51,53,55,56,57].includes(code)) return { icon: "üå¶Ô∏è", label: t("home.weatherDrizzle") };
      if ([61,63,65,66,67].includes(code)) return { icon: "üåßÔ∏è", label: t("home.weatherRain") };
      if ([71,73,75,77,85,86].includes(code)) return { icon: "üå®Ô∏è", label: t("home.weatherSnow") };
      if ([80,81,82].includes(code)) return { icon: "üå¶Ô∏è", label: t("home.weatherRainShowers") };
      if ([95].includes(code)) return { icon: "‚õàÔ∏è", label: t("home.weatherThunderstorm") };
      if ([96,99].includes(code)) return { icon: "‚õàÔ∏è", label: t("home.weatherThunderstormHail") };

      return { icon: "‚ùî", label: t("home.weatherUnknown") };
    }

    function markerColorByScore(score) {
      if (typeof score !== "number") return "#94a3b8"; // gray
      if (score >= 70) return "#22c55e";
      if (score >= 40) return "#eab308";
      return "#f97373";
    }

    function makeDot(color) {
      return `<span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${color};margin-right:6px;"></span>`;
    }

    async function loadSpotCatches(user, spotId) {
      const catchesRef = collection(db, "users", user.uid, "catches");
      const qC = query(catchesRef, where("spotId", "==", spotId));
      const snap = await getDocs(qC);

      const arr = [];
      snap.forEach(d => {
        const c = d.data();
        arr.push({
          ...c,
          weatherTemp: c.weatherTemp,
          weatherWindMs: c.weatherWindMs,
          weatherPressure: c.weatherPressure,
          weatherWindDirDeg: c.weatherWindDirDeg,
          moonPhase: c.moonPhase
        });
      });
      return arr;
    }

    async function computeWeatherAndNext3(lat, lng, spotCatches) {
      let weatherNowHtml = t("pred.weatherFailedToLoad");
      let tomorrowScore = null;
      const next3 = [];

      try {
        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${lat}&longitude=${lng}` +
          `&current=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code,pressure_msl,cloudcover` +
          `&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,pressure_msl,cloudcover` +
          `&daily=sunrise,sunset` +
          `&forecast_days=4&wind_speed_unit=ms&timezone=auto`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const cur = data.current || {};
        const tempNow = (typeof cur.temperature_2m === "number") ? cur.temperature_2m : null;
        const windNow = (typeof cur.wind_speed_10m === "number") ? cur.wind_speed_10m : null;
        const codeNow = cur.weather_code;

        const { icon, label } = getWeatherIconAndLabel(codeNow);
        const parts = [];
        if (label) parts.push(label);
        if (tempNow != null) parts.push(`${tempNow.toFixed(1)} ${t("home.unitCelsius")}`);
        if (windNow != null) parts.push(`${t("home.wind")} ${windNow.toFixed(1)} ${t("home.unitMetersPerSecond")}`);

        weatherNowHtml = parts.length
          ? `${t("home.weatherNow")}: ${icon} ${parts.join(", ")}`
          : t("pred.weatherNotAvailable");

        for (let offset = 1; offset <= 3; offset++) {
          const dateLabel = dateLabelForOffset(offset);

          const score = computeDayScoreFromForecast(
            data,
            spotCatches,
            offset,
            { mode: "avgTopN", topN: 8, daylightPadHours: 1 }
          );

          if (offset === 1) tomorrowScore = (typeof score === "number") ? score : null;
          next3.push({ dateLabel, score: (typeof score === "number") ? score : null });
        }
      } catch {
        // keep defaults
      }

      return { weatherNowHtml, tomorrowScore, next3 };
    }

    function initMap() {
      map = L.map("map").setView([58.7, 25.0], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      initMap();

      try {
        const spotsRef = collection(db, "users", user.uid, "spots");
        const snap = await getDocs(spotsRef);

        const spots = [];
        snap.forEach(d => spots.push({ id: d.id, ...d.data() }));

        if (!spots.length) return;

        for (const spot of spots) {
          const lat = spot.lat;
          const lng = spot.lng;
          if (typeof lat !== "number" || typeof lng !== "number") continue;

          const spotCatches = await loadSpotCatches(user, spot.id);
          const wx = await computeWeatherAndNext3(lat, lng, spotCatches);

          const color = markerColorByScore(wx.tomorrowScore);

          const marker = L.circleMarker([lat, lng], {
            radius: 10,
            weight: 2,
            color: color,
            fillColor: color,
            fillOpacity: 0.85
          }).addTo(map);

          const name = spot.name || t("spotPage.unnamedSpot");
          const totalCatches = spotCatches.length;
          const biggest = (() => {
            const ws = spotCatches.map(c => Number(c.weightKg)).filter(x => Number.isFinite(x) && x > 0);
            return ws.length ? Math.max(...ws) : 0;
          })();

          const lines = [];
          lines.push(`<b>${name}</b>`);
          lines.push(`${t("home.statsTotalCatches")}: ${totalCatches}, ${t("home.biggestFish")}: ${biggest.toFixed(2)} kg`);
          lines.push(wx.weatherNowHtml);
          lines.push(`<div style="margin-top:6px;"><b>${t("home.predictionNext3Days")}</b>:</div>`);

          if (!wx.next3.length) {
            lines.push(t("pred.noForecastData"));
          } else {
            wx.next3.forEach(d => {
              const s = (typeof d.score === "number") ? `${d.score.toFixed(0)}%` : t("home.na");
              lines.push(`${d.dateLabel}: ${s}`);
            });
          }

          lines.push(`<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">`);
          lines.push(`<a class="secondary-btn" href="spot.html?spotId=${spot.id}">${t("home.openSpot")}</a>`);
          lines.push(`<a class="secondary-btn" href="add-catch.html?spotId=${spot.id}">${t("home.AddCatch")}</a>`);
          lines.push(`<a class="secondary-btn" href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">${t("home.googleMaps")}</a>`);
          lines.push(`</div>`);

          marker.bindPopup(lines.join("<br/>"), { maxWidth: 320 });
        }
      } catch {
        // silent
      }

      if (i18n && typeof i18n.applyTranslations === "function") i18n.applyTranslations();
    });
  </script>
</body>
</html>
