<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>My Fishing Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app fade-in">

    <header class="card">
      <div class="card-header">
        <div>
          <h1 data-i18n="home.title">My Fishing Log</h1>
          <p class="muted-text" data-i18n="home.subtitle">
            Track your catches anywhere â€“ with login, spots, weather & predictions.
          </p>
        </div>

        <div id="userArea" style="display:flex; gap:10px; align-items:center;">
          <div id="userLabel" class="muted-text" style="text-align:right;"></div>
          <button id="settingsBtn" class="secondary-btn" data-i18n="home.settings" style="display:none;">Settings</button>
          <button id="logoutBtn" class="secondary-btn" data-i18n="home.logOut" style="display:none;">Log out</button>
        </div>
      </div>
    </header>

    <div class="card" id="authCard" style="display:none;">
      <h2 data-i18n="auth.title">Log in or sign up</h2>
      <div class="grid-2" style="margin-top:10px;">
        <input id="emailInput" type="email" placeholder="Email" data-i18n-placeholder="auth.emailPlaceholder" />
        <input id="passwordInput" type="password" placeholder="Password" data-i18n-placeholder="auth.passwordPlaceholder" />
      </div>

      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button id="loginBtn" class="primary-btn" data-i18n="auth.logIn">Log in</button>
        <button id="signupBtn" class="secondary-btn" data-i18n="auth.signUp">Sign up</button>
        <span class="muted-text" style="align-self:center;" data-i18n="auth.or">or</span>
        <button id="googleBtn" class="secondary-btn" data-i18n="auth.continueWithGoogle">Continue with Google</button>
      </div>

      <p id="authMsg" class="muted-text" style="margin-top:8px;"></p>
    </div>

    <div class="card" id="statsCard" style="display:none;">
      <h2 data-i18n="home.statsTitle">Stats</h2>
      <div id="statsArea" class="muted-text" style="margin-top:6px;"></div>
    </div>

    <div class="card" id="spotsCard" style="display:none;">
      <div class="card-header">
        <div>
          <h2 data-i18n="home.spotsTitle">My fishing spots</h2>
          <p class="muted-text" id="spotsSubtext"></p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="secondary-btn" href="spots-map.html" data-i18n="home.mapView">Map view</a>
          <a class="secondary-btn" href="add-spot.html" data-i18n="home.addNewSpot">Add new spot</a>
        </div>
      </div>
      <div id="spotsList"></div>
    </div>

  </div>

  <script src="translations.js"></script>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    import { computeDayScoreFromForecast } from "./predictions-core.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const i18n = window.fishingLogI18n;
    const t = (k) => (i18n && typeof i18n.t === "function") ? i18n.t(k) : k;

    const authCard = document.getElementById("authCard");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const googleBtn = document.getElementById("googleBtn");
    const authMsg = document.getElementById("authMsg");

    const statsCard = document.getElementById("statsCard");
    const statsArea = document.getElementById("statsArea");

    const spotsCard = document.getElementById("spotsCard");
    const spotsList = document.getElementById("spotsList");
    const spotsSubtext = document.getElementById("spotsSubtext");

    const userLabel = document.getElementById("userLabel");
    const settingsBtn = document.getElementById("settingsBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function getWeekdayShortName(idx) {
      const keys = [
        "home.weekdaySun",
        "home.weekdayMon",
        "home.weekdayTue",
        "home.weekdayWed",
        "home.weekdayThu",
        "home.weekdayFri",
        "home.weekdaySat"
      ];
      return t(keys[idx] || keys[0]);
    }

    function getWeatherIconAndLabel(code) {
      if (code === 0)  return { icon: "â˜€ï¸", label: t("home.weatherClear") };
      if (code === 1)  return { icon: "ðŸŒ¤ï¸", label: t("home.weatherMainlyClear") };
      if (code === 2)  return { icon: "â›…",  label: t("home.weatherPartlyCloudy") };
      if (code === 3)  return { icon: "â˜ï¸",  label: t("home.weatherOvercast") };

      if (code === 45 || code === 48) return { icon: "ðŸŒ«ï¸", label: t("pred.weatherFog") };

      if ([51,53,55,56,57].includes(code)) return { icon: "ðŸŒ¦ï¸", label: t("home.weatherDrizzle") };
      if ([61,63,65,66,67].includes(code)) return { icon: "ðŸŒ§ï¸", label: t("home.weatherRain") };
      if ([71,73,75,77,85,86].includes(code)) return { icon: "ðŸŒ¨ï¸", label: t("home.weatherSnow") };
      if ([80,81,82].includes(code)) return { icon: "ðŸŒ¦ï¸", label: t("home.weatherRainShowers") };
      if ([95].includes(code)) return { icon: "â›ˆï¸", label: t("home.weatherThunderstorm") };
      if ([96,99].includes(code)) return { icon: "â›ˆï¸", label: t("home.weatherThunderstormHail") };

      return { icon: "â”", label: t("home.weatherUnknown") };
    }

    loginBtn.onclick = async () => {
      authMsg.textContent = "";
      const email = (emailInput.value || "").trim();
      const pass = passwordInput.value || "";
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        authMsg.textContent = `${t("auth.loginFailedPrefix")} ${e.message}`;
      }
    };

    signupBtn.onclick = async () => {
      authMsg.textContent = "";
      const email = (emailInput.value || "").trim();
      const pass = passwordInput.value || "";
      if (!email || !pass) {
        authMsg.textContent = t("auth.enterEmailPassword");
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        authMsg.textContent = `${t("auth.signUpFailedPrefix")} ${e.message}`;
      }
    };

    googleBtn.onclick = async () => {
      authMsg.textContent = "";
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (e) {
        authMsg.textContent = `${t("auth.googleFailedPrefix")} ${e.message}`;
      }
    };

    settingsBtn.onclick = () => { window.location.href = "settings.html"; };
    logoutBtn.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authCard.style.display = "block";
        statsCard.style.display = "none";
        spotsCard.style.display = "none";
        settingsBtn.style.display = "none";
        logoutBtn.style.display = "none";
        userLabel.textContent = "";
        if (i18n) i18n.applyTranslations();
        return;
      }

      authCard.style.display = "none";
      statsCard.style.display = "block";
      spotsCard.style.display = "block";
      settingsBtn.style.display = "inline-flex";
      logoutBtn.style.display = "inline-flex";

      await loadProfileAndSetHeader(user);
      await loadStats(user);
      await loadSpots(user);

      if (i18n) i18n.applyTranslations();
    });

    async function loadProfileAndSetHeader(user) {
      let displayName = user.email || "";
      try {
        const profileRef = doc(db, "profiles", user.uid);
        const snap = await getDoc(profileRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.displayName) displayName = data.displayName;
        }
      } catch {}

      userLabel.innerHTML = `<span class="muted-text">${t("common.loggedInAs")}</span> <b>${displayName}</b>`;
    }

    async function loadStats(user) {
      statsArea.textContent = t("home.loading");

      try {
        const catchesRef = collection(db, "users", user.uid, "catches");
        const snap = await getDocs(catchesRef);

        const all = [];
        snap.forEach(d => all.push(d.data()));

        if (!all.length) {
          statsArea.textContent = t("home.noCatchesYet");
          return;
        }

        const weights = all.map(c => Number(c.weightKg)).filter(x => Number.isFinite(x) && x > 0);
        const total = all.length;

        const biggest = weights.length ? Math.max(...weights) : null;
        const avg = weights.length ? (weights.reduce((a, b) => a + b, 0) / weights.length) : null;

        const lines = [];
        lines.push(`${t("home.statsTotalCatches")}: <b>${total}</b>`);
        lines.push(`${t("home.biggestFish")}: <b>${biggest != null ? biggest.toFixed(2) + " kg" : t("home.na")}</b>`);
        lines.push(`${t("home.statsAverageWeight")}: <b>${avg != null ? avg.toFixed(2) + " kg" : t("home.na")}</b>`);

        statsArea.innerHTML = lines.join(" Â· ");
      } catch {
        statsArea.textContent = t("home.unavailable");
      }
    }

    async function loadSpots(user) {
      spotsList.innerHTML = "";
      spotsSubtext.textContent = t("home.loading");

      try {
        const spotsRef = collection(db, "users", user.uid, "spots");
        const snap = await getDocs(spotsRef);

        const spots = [];
        snap.forEach(d => spots.push({ id: d.id, ...d.data() }));

        if (!spots.length) {
          spotsSubtext.textContent = t("home.noSpotsYet");
          return;
        }

        spotsSubtext.textContent = "";

        for (const spot of spots) {
          const row = document.createElement("div");
          row.className = "spot-row";

          const headerLine = document.createElement("div");
          headerLine.className = "spot-header-line";

          const title = document.createElement("h3");
          title.textContent = spot.name || t("spotPage.unnamedSpot");
          headerLine.appendChild(title);

          row.appendChild(headerLine);

          const info = document.createElement("div");
          info.className = "muted-text";
          info.style.marginTop = "6px";
          info.innerHTML = `<span id="wx-${spot.id}">${t("home.loading")}</span><br/><span id="pred-${spot.id}">${t("home.loading")}</span>`;
          row.appendChild(info);

          const actions = document.createElement("div");
          actions.className = "spot-actions";

          const openBtn = document.createElement("a");
          openBtn.className = "secondary-btn";
          openBtn.href = `spot.html?spotId=${spot.id}`;
          openBtn.textContent = t("home.openSpot");
          actions.appendChild(openBtn);

          const addCatchBtn = document.createElement("a");
          addCatchBtn.className = "secondary-btn";
          addCatchBtn.href = `add-catch.html?spotId=${spot.id}`;
          addCatchBtn.textContent = t("home.AddCatch");
          actions.appendChild(addCatchBtn);

          const predBtn = document.createElement("a");
          predBtn.className = "secondary-btn";
          predBtn.href = `predictions.html?spotId=${spot.id}`;
          predBtn.textContent = t("home.predictions");
          actions.appendChild(predBtn);

          if (typeof spot.lat === "number" && typeof spot.lng === "number") {
            const mapsBtn = document.createElement("a");
            mapsBtn.className = "secondary-btn";
            mapsBtn.href = `https://www.google.com/maps?q=${spot.lat},${spot.lng}`;
            mapsBtn.target = "_blank";
            mapsBtn.rel = "noopener";
            mapsBtn.textContent = t("home.googleMaps");
            actions.appendChild(mapsBtn);
          }

          row.appendChild(actions);
          spotsList.appendChild(row);

          // Load weather & predictions for this spot
          await fillWeatherAndPred(user, spot);
        }

      } catch {
        spotsSubtext.textContent = t("home.unavailable");
      }
    }

    async function fillWeatherAndPred(user, spot) {
      const wxEl = document.getElementById(`wx-${spot.id}`);
      const predEl = document.getElementById(`pred-${spot.id}`);

      if (!wxEl || !predEl) return;

      if (typeof spot.lat !== "number" || typeof spot.lng !== "number") {
        wxEl.textContent = t("home.locationMissing");
        predEl.textContent = t("home.locationMissing");
        return;
      }

      // Load catches for this spot
      let spotCatches = [];
      try {
        const catchesRef = collection(db, "users", user.uid, "catches");
        const qc = query(catchesRef, where("spotId", "==", spot.id));
        const snap = await getDocs(qc);
        snap.forEach(d => {
          const c = d.data();
          spotCatches.push({
            ...c,
            weatherTemp: c.weatherTemp,
            weatherWindMs: c.weatherWindMs,
            weatherPressure: c.weatherPressure,
            weatherWindDirDeg: c.weatherWindDirDeg,
            moonPhase: c.moonPhase
          });
        });
      } catch {
        wxEl.textContent = t("home.failedToLoad");
        predEl.textContent = t("home.failedToLoad");
        return;
      }

      try {
        const lat = spot.lat;
        const lng = spot.lng;

        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${lat}&longitude=${lng}` +
          `&current=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code,pressure_msl,cloudcover` +
          `&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,pressure_msl,cloudcover` +
          `&daily=sunrise,sunset` +
          `&forecast_days=4&wind_speed_unit=ms&timezone=auto`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const cur = data.current || {};
        const ct = cur.temperature_2m;
        const cw = cur.wind_speed_10m;
        const cc = cur.weather_code;

        const { icon, label } = getWeatherIconAndLabel(cc);
        const parts = [];
        if (label) parts.push(label);
        if (typeof ct === "number") parts.push(`${ct.toFixed(1)} ${t("home.unitCelsius")}`);
        if (typeof cw === "number") parts.push(`${t("home.wind")} ${cw.toFixed(1)} ${t("home.unitMetersPerSecond")}`);

        wxEl.innerHTML = `<b>${t("home.weatherNow")}</b>: ${icon} ${parts.join(", ")}`;

        const pieces = [];
        for (let offset = 1; offset <= 3; offset++) {
          const base = new Date();
          base.setDate(base.getDate() + offset);
          const wd = getWeekdayShortName(base.getDay());

          const score = computeDayScoreFromForecast(data, spotCatches, offset);
          if (typeof score !== "number") {
            pieces.push(`${wd}: ${t("home.na")}`);
            continue;
          }

          let color = "#f97373";
          if (score >= 70) color = "#22c55e";
          else if (score >= 40) color = "#eab308";

          pieces.push(`${wd} <span style="color:${color};font-weight:600;">${score.toFixed(0)}%</span>`);
        }

        if (pieces.length) {
          predEl.innerHTML = `<b>${t("home.predictionNext3Days")}</b>: ${pieces.join(" Â· ")}`;
        } else {
          predEl.innerHTML = `<b>${t("home.predictionNext3Days")}</b>: <span data-i18n="home.notEnoughDataYet">${t("home.notEnoughDataYet")}</span>`;
        }

      } catch {
        wxEl.textContent = t("home.failedToLoad");
        predEl.textContent = t("home.failedToLoad");
      }
    }
  </script>
</body>
</html>
